<!doctype html>

<html lang="fr">
	<head>
		<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
		<!--[if lt IE 9]><script src="js/html5.js"></script><![endif]-->
		<meta charset="UTF-8">
		<title>Ski path finder</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="css/style.css" media="all">
		<link rel="stylesheet" href="css/jquery-ui.css" media="all">

		<!-- Inclusion de jQuery et jQuery-ui -->
		<script src="js/jquery-1.10.2.js"></script>
		<script src="js/jquery-ui.js"></script>
		<script src="js/jquery-mousewheel.js"></script>
	</head>
	<body id="body">
		<header role="banner">
			<h1>Ski path finder</h1>
		</header>
		
		<aside>
			<h1>Path</h1>
			<label for="listeDepart"><img src="img/iconD.png" /></label>
			<select name="listeDepart" id="listeDepart">
				<option value="0"></option>
			</select>
			<br />
			<label for="listeArrivee"><img src="img/iconA.png" /></label>
			<select name="listeArrivee" id="listeArrivee">
				<option value="0"></option>
			</select>
		</aside>

		<section role="main" id="main">
			<img src="img/pistes2.jpg" id="image" />
			<div id="container">
			</div>
		</section>

		<footer role="contentinfo" id="footer">
			<ul>
				<li><a href="javascript:lecture();">par Antoine Lamielle</a></li>
				<li><a href="javascript:image.marqueurs.addStart(Number(prompt('x = ', '')),Number(prompt('y = ', '')),5);">licence GNU GPL v3</a></li>
				<li><a href="javascript:image.marqueurs.removeStart();">fork me on Github</a></li>
			</ul>
		</footer>

		<div id="infobox"></div>
		<div id="get" style="display: none;"></div>
		<div id="tty"></div>

		<!-- Gestion de la carte -->
		<script>
			/* Gestion du zoom */
			function Zoom(parent) {
				this.parent = parent;
				this.val = 1;
				this.updateZoom = function() {
					$('#image').css('transform', 'scale('+this.val+')');
					this.parent.marqueurs.update();
					if($('#image').position().left > 0)
						$('#image').css('left', '0');
					if($('#image').position().top > 0)
						$('#image').css('top', '0');
					if($('#image').position().left < $("#body").width() - $("#image").width()*this.val)
						$('#image').css('left', ''+($("#body").width() - $("#image").width()*this.val)+'');
					if($('#image').position().top < $("#body").height() - $("#image").height()*this.val - $("#footer").height())
						$('#image').css('top', ''+($("#body").height() - $("#image").height()*this.val - $("#footer").height())+'');
					this.parent.setDrag();
				}
			}

			/* Gestion des marqueurs */
			function Marqueurs(parent) {
				this.parent = parent;
				this.factor = $("#image").width()/this.parent.width;
				this.posMarkerX = [];
				this.posMarkerY = [];
				
				this.updateFactor = function() {
					this.factor = $("#image").width()/this.parent.width;
				}

				this.update = function() {
					$("#container span").each(function(i) {
						$(this).css('left', image.marqueurs.posMarkerX[i]*image.zoom.val*image.marqueurs.factor + image.offsetX + $("#image").position().left);
						$(this).css('top', image.marqueurs.posMarkerY[i]*image.zoom.val*image.marqueurs.factor + image.offsetY + $("#image").position().top);
					});
				}
			 	this.add = function(x, y, id, icon) {
			 		$("#container").append('<span style="left: '+y+'px; top: '+x+'px; position: absolute;" title="" class="'+id+'">'+icon+'</span>');

			 		$("#container span:last").hover(
						function() {
							var m = this;
							$('#infobox').empty();
							$("#infobox").html("<h3>Nom</h3><p>"+vertices[parseInt($(this).attr('class'))-1][1]+"</p><h3>Altitude</h3><p>"+vertices[parseInt($(this).attr('class'))-1][2]+"</p>");
							$("#infobox").dialog({modal: false,resizable: false,position: { my: "left bottom", at: "right top", of: m}, width:100});
							$("#infobox").closest(".ui-dialog").find(".ui-dialog-titlebar:first").hide();
						}, function() {
							$("#infobox").dialog("close");
						}
					);
			 		this.posMarkerX.push(x);
					this.posMarkerY.push(y);
			 		this.update();
			 	}
			 	this.addStart = function(x, y, id) {
			 		this.add(x, y, id, "D");
			 	}
			 	this.addEnd = function(x, y, id) {
			 		this.add(x, y, id, "A");
			 	}
			 	this.removeInt = function() {
			 		$("#container span").each(function(i) {
			 			$(this).remove();
				 		image.marqueurs.posMarkerX.pop();
				 		image.marqueurs.posMarkerY.pop();
			 		});
			 		if(parseInt($('#listeDepart option:selected').attr("value")) > 0)
						image.marqueurs.addStart(vertices[parseInt($('#listeDepart option:selected').attr("value"))-1][3],vertices[parseInt($('#listeDepart option:selected').attr("value"))-1][4], parseInt($('#listeDepart option:selected').attr("value")));
			 		if(parseInt($('#listeArrivee option:selected').attr("value")) > 0)
						image.marqueurs.addEnd(vertices[parseInt($('#listeArrivee option:selected').attr("value"))-1][3],vertices[parseInt($('#listeArrivee option:selected').attr("value"))-1][4], parseInt($('#listeArrivee option:selected').attr("value")));
			 	}
			 	this.removeLast = function() {
			 		this.posMarkerX.pop();
			 		this.posMarkerY.pop();
			 		$("#container span:last").remove();
			 		this.update();
			 	}
			 	this.removeStart = function() {
			 		var pos = -1;
			 		$("#container span").each(function(i) {
			 			if($(this).text() == "D") {
			 				pos = i;
			 				$(this).remove();
			 			}
			 		});
			 		if(pos != -1) {
				 		for(i=pos; i<this.posMarkerX.length;i++) {
				 			this.posMarkerX[i] = this.posMarkerX[i+1];
				 			this.posMarkerY[i] = this.posMarkerY[i+1];
				 		}
				 		this.posMarkerX.pop();
				 		this.posMarkerY.pop();
			 		}
			 		this.update();
			 	}
			 	this.removeEnd = function() {
			 		var pos = -1;
			 		$("#container span").each(function(i) {
			 			if($(this).text() == "A") {
			 				pos = i;
			 				$(this).remove();
			 			}
			 		});
			 		if(pos != -1) {
				 		for(i=pos; i<this.posMarkerX.length;i++) {
				 			this.posMarkerX[i] = this.posMarkerX[i+1];
				 			this.posMarkerY[i] = this.posMarkerY[i+1];
				 		}
				 		this.posMarkerX.pop();
				 		this.posMarkerY.pop();
			 		}
			 		this.update();
			 	}
			}

			/* Gestion globale de la carte */
			function Image() {
				this.width = 3480;
				this.height = 2000;
				this.offsetX = -27/2;
				this.offsetY = -40;
				
				this.zoom = new Zoom(this);
				this.marqueurs = new Marqueurs(this);

			 	this.setDrag = function() {
			 		var left = $("#body").width() - $("#image").width()*this.zoom.val;
					var top = $("#body").height() - $("#image").height()*this.zoom.val - $("#footer").height();
					var right = 0;
					var bottom = 0;
					$('#image').draggable({ cursor: "move", scroll: false, containment: [left, top, right, bottom], drag: function(){image.marqueurs.update();}});
			 	}
			 	this.setWheel = function() {
					$('#image').mousewheel(function(event, delta) {
						 if (event.deltaY > 0)
		                    image.zoom.val += 0.1;
		                else if (event.deltaY < 0 && image.zoom.val > 1)
		                    image.zoom.val -= 0.1;
						image.zoom.updateZoom();
					});
			 	}
			
			}
		</script>

		<!-- Lecture des données -->
		<script>
			var vertices = [0];
			var connections = [0];

			function lecture() {
				$("#get").load("data.txt",function(data){
					var i;
					var reg=new RegExp("[\n]+", "g");
					var tmp=data.split(reg);
					reg = new RegExp("[\t]+", "g");
					for(i=1; i<parseInt(tmp[0])+1; i++) {
						vertices.push(tmp[i].split(reg));
						$("#listeDepart").append('<option value="'+vertices[i][0]+'">'+vertices[i][1]+'</option>');
						$("#listeArrivee").append('<option value="'+vertices[i][0]+'">'+vertices[i][1]+'</option>');
					}
					i++;
					for(;i<tmp.length-1;i++)
						connections.push(tmp[i].split(reg));
					for(i=1; i<connections.length; i++) {
						switch(connections[i][2]) {
							case "V":
								connections[i][5] = (parseInt(vertices[parseInt(connections[i][3])-1][2]) - parseInt(vertices[parseInt(connections[i][4])-1][2]))/20;
								break;
							case "B":
								connections[i][5] = (parseInt(vertices[parseInt(connections[i][3])-1][2]) - parseInt(vertices[parseInt(connections[i][4])-1][2]))/25;
								break;
							case "R":
								connections[i][5] = (parseInt(vertices[parseInt(connections[i][3])-1][2]) - parseInt(vertices[parseInt(connections[i][4])-1][2]))*3/100;
								break;
							case "N":
								connections[i][5] = (parseInt(vertices[parseInt(connections[i][3])-1][2]) - parseInt(vertices[parseInt(connections[i][4])-1][2]))/50;
								break;
							case "KL":
								connections[i][5] = (parseInt(vertices[parseInt(connections[i][3])-1][2]) - parseInt(vertices[parseInt(connections[i][4])-1][2]))/600;
								break;
							case "SURF":
								connections[i][5] = (parseInt(vertices[parseInt(connections[i][3])-1][2]) - parseInt(vertices[parseInt(connections[i][4])-1][2]))/10;
								break;
							case "TPH":
								connections[i][5] = 4 + (parseInt(vertices[parseInt(connections[i][4])-1][2]) - parseInt(vertices[parseInt(connections[i][3])-1][2]))/50;
								break;
							case "TC":
								connections[i][5] = 2 + (parseInt(vertices[parseInt(connections[i][4])-1][2]) - parseInt(vertices[parseInt(connections[i][3])-1][2]))*3/100;
								break;
							case "TSD":
								connections[i][5] = 1 + (parseInt(vertices[parseInt(connections[i][4])-1][2]) - parseInt(vertices[parseInt(connections[i][3])-1][2]))*3/100;
								break;
							case "TS":
								connections[i][5] = 1 + (parseInt(vertices[parseInt(connections[i][4])-1][2]) - parseInt(vertices[parseInt(connections[i][3])-1][2]))/25;
								break;
							case "TK":
								connections[i][5] = 1 + (parseInt(vertices[parseInt(connections[i][4])-1][2]) - parseInt(vertices[parseInt(connections[i][3])-1][2]))/25;
								break;
							case "BUS":
								if(parseInt(connections[i][3]) == 7 || parseInt(connections[i][4]) == 7)
									connections[i][5] = 40;
								else
									connections[i][5] = 30;
								break;
						}
					}
				});
			}
		</script>

		<!-- Calcul du trajet -->
		<script>
			function calculate() {
				if(parseInt($('#listeDepart option:selected').attr("value")) != 0 && parseInt($('#listeArrivee option:selected').attr("value")) != 0) {
					$( "#listeDepart" ).selectmenu( "disable" );
					$( "#listeArrivee" ).selectmenu( "disable" );
					
					image.marqueurs.removeInt();
					
					var aVisiter = [];
					var found = false;
					var i;
					var courant;
					var temps = 0;

					for(i=0; i<vertices.length; i++) {
						vertices[i][6] = 999999;
						vertices[i][7] = 0;
						vertices[i][8] = 0;
					}
					vertices[parseInt($('#listeDepart option:selected').attr("value"))-1][6] = 0;
					aVisiter.unshift(parseInt($('#listeDepart option:selected').attr("value")));
					while(aVisiter.length != 0 && found == false) {
						courant = aVisiter.pop();
						for(i=0; i<connections.length; i++) {
							if(parseInt(connections[i][3]) == courant) {
								if(parseInt(vertices[parseInt(connections[i][4])-1][6]) > vertices[parseInt(connections[i][3])-1][6] + connections[i][5]) {

									vertices[parseInt(connections[i][4])-1][6] = vertices[parseInt(connections[i][3])-1][6] + connections[i][5];
									vertices[parseInt(connections[i][4])-1][7] = courant;
									vertices[parseInt(connections[i][4])-1][8] = i+1;
									aVisiter.unshift(parseInt(connections[i][4]));
								}
							}
						}
					}
					
					if(vertices[parseInt($('#listeArrivee option:selected').attr("value"))-1][7] == 0)
						alert("Aucun chemin n'a été trouvé entre les deux points");
					else {
						courant = parseInt($('#listeArrivee option:selected').attr("value"));
						i = -2;
						while(courant != 0) {
							courant = vertices[courant-1][7];
							i++;
						}
						courant = parseInt($('#listeArrivee option:selected').attr("value"));
						while(courant != 0) {
							if(i > 0 && courant != parseInt($('#listeArrivee option:selected').attr("value"))) {
								image.marqueurs.add(vertices[courant-1][3], vertices[courant-1][4], courant, i--);
								temps += connections[vertices[courant][8]][5];
								alert("Connexion "+vertices[courant][8]+" : "+connections[vertices[courant][8]][5]+"min");
							}
							courant = vertices[courant-1][7];
						}
					}
					
					$( "#listeDepart" ).selectmenu( "enable" );
					$( "#listeArrivee" ).selectmenu( "enable" );
				}
			}
		</script>

		<!-- Lancement des modules -->
		<script>
			var image = new Image();

			$(function() {
				image.setDrag();
				image.setWheel();
				lecture();
				$("#listeDepart").selectmenu({select: function( event, ui ) {
					image.marqueurs.removeStart();
					if(parseInt($('#listeDepart option:selected').attr("value")) > 0)
						image.marqueurs.addStart(vertices[parseInt($('#listeDepart option:selected').attr("value"))-1][3],vertices[parseInt($('#listeDepart option:selected').attr("value"))-1][4], parseInt($('#listeDepart option:selected').attr("value")));
					calculate();
				}});
				$("#listeArrivee").selectmenu({select: function( event, ui ) {
					image.marqueurs.removeEnd();
					if(parseInt($('#listeArrivee option:selected').attr("value")) > 0)
						image.marqueurs.addEnd(vertices[parseInt($('#listeArrivee option:selected').attr("value"))-1][3],vertices[parseInt($('#listeArrivee option:selected').attr("value"))-1][4], parseInt($('#listeArrivee option:selected').attr("value")));
					calculate();
				}});
			});

			$(window).resize(function() {
				image.setDrag();
				image.marqueurs.updateFactor();
			});
		</script>
	</body>
</html>

