<!doctype html>

<html lang="fr">
	<head>
		<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
		<!--[if lt IE 9]><script src="js/html5.js"></script><![endif]-->
		<meta charset="UTF-8">
		<title>Ski path finder</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="css/style.css" media="all">
		<link rel="stylesheet" href="css/jquery-ui.css" media="all">

		<!-- Inclusion de jQuery et jQuery-ui -->
		<script src="js/jquery-1.10.2.js"></script>
		<script src="js/jquery-ui.js"></script>
		<script src="js/jquery-mousewheel.js"></script>
	</head>
	<body id="body">
		<header role="banner">
			<h1>Ski path finder</h1>
		</header>
		
		<aside>
			<h1>Path</h1>
			<label for="listeDepart">Start</label>
			<select name="listeDepart" id="listeDepart">
			</select><br />
			<label for="listeArrivee">End</label>
			<select name="listeArrivee" id="listeArrivee">
			</select>
		</aside>

		<section role="main" id="main">
			<img src="img/pistes2.jpg" id="image" usemap="#map" />
			<map name="map">
				<area id="5" shape="rect" coords="750,700,900,850" href="#" />
			</map>
			<div id="container">
			</div>
		</section>

		<footer role="contentinfo" id="footer">
			<ul>
				<li><a href="javascript:lecture();">par Antoine Lamielle</a></li>
				<li><a href="javascript:image.marqueurs.addStart(Number(prompt('x = ', '')),Number(prompt('y = ', '')));">licence GNU GPL v3</a></li>
				<li><a href="javascript:image.marqueurs.removeLast();">fork me on Github</a></li>
			</ul>
		</footer>

		<div id="infobox"></div>
		<div id="get" style="display: none;"></div>

		<!-- Gestion de la carte -->
		<script>
			var line = [];
			/* Gestion du zoom */
			function Zoom(parent) {
				this.parent = parent;
				this.val = 1;
				this.updateZoom = function() {
					$('#image').css('transform', 'scale('+this.val+')');
					this.parent.marqueurs.update();
					if($('#image').position().left > 0)
						$('#image').css('left', '0');
					if($('#image').position().top > 0)
						$('#image').css('top', '0');
					if($('#image').position().left < $("#body").width() - $("#image").width()*this.val)
						$('#image').css('left', ''+($("#body").width() - $("#image").width()*this.val)+'');
					if($('#image').position().top < $("#body").height() - $("#image").height()*this.val - $("#footer").height())
						$('#image').css('top', ''+($("#body").height() - $("#image").height()*this.val - $("#footer").height())+'');
					this.parent.setDrag();
				}
			}

			/* Gestion des marqueurs */
			function Marqueurs(parent) {
				this.parent = parent;
				this.factor = $("#image").width()/this.parent.width;
				this.posMarkerX = [];
				this.posMarkerY = [];
				
				this.updateFactor = function() {
					this.factor = $("#image").width()/this.parent.width;
				}

				this.update = function() {
					$("#container span").each(function(i) {
						$(this).css('left', image.marqueurs.posMarkerX[i]*image.zoom.val*image.marqueurs.factor + image.offsetX + $("#image").position().left);
						$(this).css('top', image.marqueurs.posMarkerY[i]*image.zoom.val*image.marqueurs.factor + image.offsetY + $("#image").position().top);
					});
				}
			 	this.add = function(x, y, id, icon) {
			 		$("#container").append('<span style="left: '+y+'px; top: '+x+'px; position: absolute;" title="" class="'+id+'">'+icon+'</span>');

			 		$("#container span:last").hover(
						function() {
							var m = this;
							$('#infobox').empty();
							$("#infobox").html("<h3>Nom</h3><p>"+line[parseInt($(this).attr('class'))-1][1]+"</p><h3>Altitude</h3><p>"+line[parseInt($(this).attr('class'))-1][2]+"</p>");
							$("#infobox").dialog({modal: false,resizable: false,position: { my: "left bottom", at: "right top", of: m}, width:100});
							$("#infobox").closest(".ui-dialog").find(".ui-dialog-titlebar:first").hide();
						}, function() {
							$("#infobox").dialog("close");
						}
					);
			 		this.posMarkerX.push(x);
					this.posMarkerY.push(y);
			 		this.update();
			 	}
			 	this.addStart = function(x, y) {
			 		this.add(x, y, 5, "D");
			 	}
			 	this.addEnd = function(x, y) {
			 		this.add(x, y, "A", "Arrivée");
			 	}
			 	this.addInt = function(x, y) {
			 		this.add(x, y, "I", "Intermédiaire");
			 	}
			 	this.removeLast = function() {
			 		this.posMarkerX.pop();
			 		this.posMarkerY.pop();
			 		$("#container span:last").remove();
			 		this.update();
			 	}
			}

			/* Gestion globale de la carte */
			function Image() {
				this.width = 3480;
				this.height = 2000;
				this.offsetX = -27/2;
				this.offsetY = -40;
				
				this.zoom = new Zoom(this);
				this.marqueurs = new Marqueurs(this);

			 	this.setDrag = function() {
			 		var left = $("#body").width() - $("#image").width()*this.zoom.val;
					var top = $("#body").height() - $("#image").height()*this.zoom.val - $("#footer").height();
					var right = 0;
					var bottom = 0;
					$('#image').draggable({ cursor: "move", scroll: false, containment: [left, top, right, bottom], drag: function(){image.marqueurs.update();}});
			 	}
			 	this.setWheel = function() {
					$('#image').mousewheel(function(event, delta) {
						 if (event.deltaY > 0)
		                    image.zoom.val += 0.1;
		                else if (event.deltaY < 0 && image.zoom.val > 1)
		                    image.zoom.val -= 0.1;
						image.zoom.updateZoom();
					});
			 	}
			
			}
		</script>

		<!-- Lecture des données -->
		<script>
			function lecture() {
				$("#get").load("data.txt",function(data){
					var reg=new RegExp("[\n]+", "g");
					var tmp=data.split(reg);
					reg = new RegExp("[\t]+", "g");
					for(var i=1; i<parseInt(tmp[0]); i++) {
						line.push(tmp[i].split(reg));
						$("#"+i).hover(function(){image.marqueurs.add(parseInt(line[parseInt($(this).attr('id'))-1][3]), parseInt(line[parseInt($(this).attr('id'))-1][4]), line[parseInt($(this).attr('id'))-1][0], line[parseInt($(this).attr('id'))-1][0]);}, function(){image.marqueurs.removeLast()});
						$("#listeDepart").append('<option>'+line[i-1][1]+'</option>');
						$("#listeArrivee").append('<option>'+line[i-1][1]+'</option>');
					}
				});
			}
		</script>

		<!-- Gestion des évènements -->
		<script>
			var select = 0; //0: départ ; 1: intermédiaire ; 2: arrivée
			
			function selection(numPoint) {
				var x = 0;
				var y = 0;
				switch(select) {
					case (0):
						image.marqueurs.addStart(x, y);
						break;
					case (1):
						image.marqueurs.addInt(x, y);
						break;
					case (2):
						image.marqueurs.addEnd(x, y);
						break;
				}
			}
		</script>

		<!-- Lancement des modules -->
		<script>
			var image = new Image();

			$(function() {
				image.setDrag();
				image.setWheel();
				lecture();
				/*$("#listeDepart").selectmenu();
				$("#listeArrivee").selectmenu();*/
			});

			$(window).resize(function() {
				image.setDrag();
				image.marqueurs.updateFactor();
			});
		</script>
	</body>
</html>

